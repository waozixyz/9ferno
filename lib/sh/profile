# sh initialisation here
load std

user = `{cat /dev/user}
home = /usr/^$user
pubgridreg = tcp!registry.9p.zone!registry
cd $home

# Set ROOT - CRITICAL: must be set before mk runs
# Use empty ROOT to avoid double slash when combined with /$OBJDIR
ROOT=

# Set architecture - CRITICAL: must be set before mk runs
objtype=amd64

# CRITICAL: Bind Linux amd64 libraries to where mk expects them
# This makes /Plan9/amd64/lib/lib9.a point to the real library
bind /Linux/amd64/lib /Plan9/amd64/lib
bind /Linux/amd64/include /Plan9/amd64/include
bind /Linux/amd64/bin /Plan9/amd64/bin

# Also add to PATH
# Create /bin if it doesn't exist, then bind
{ftest -d /bin} || {mkdir /bin}
bind -a /Linux/amd64/bin /bin
bind -a /Plan9/amd64/bin /bin

# build the user's namespace in $home/
and {ftest -e namespace}	{nsbuild}

if{~ $#emuhost 0 && ~ $#emuwdir 0}{
	# running native

	# load a heap based filesystem on /tmp
	memfs
}{
	# running hosted

	# dis/init has set this up already for native booting
	mount {mntgen} /n
}

# Run the user's profile
and {ftest -e lib/profile}	{run ./lib/profile}

# kr - compile .kry to .dis and run it
fn kr {
    if {~ $#* 0} {
        echo usage: kr file.kry
    } {
        input := $1;
        base := `{basename $input .kry};
        @ /dis/kryon.dis $input;
        @ /dis/limbo.dis $base.b;
        @ /dis/sh.dis $base.dis;
    }
}
